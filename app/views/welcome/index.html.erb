<!-- <h1>Welcome#index</h1>
<p>Find me in app/views/welcome/index.html.erb</p> -->
<!-- <h1>Hello, Rails!</h1>-->


<!-- 
DOCUMENTATION:- 
Things done:-
1. AJAX working.
2. Event on tab close

Things to do:-
Parse the url(to be taken using document.URL) and send it to the controller.


-->

 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<style type="text/css">
      html { height: 100% }
      body { height: 80%;width: 50%; margin: 0; padding: 0 }
      #map { height: 100% }
    </style>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>iMap</title>
     <!-- <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    // <script type="text/javascript" src="http://maps.google.com/maps/api/js?key=AIzaSyAR_6EezXheWNmpGyHZVA8Y26WHSRrjNT8"></script>
    // <script type="text/javascript" src="ipmapper.js"></script> -->
    <!--<script type="text/javascript" src="ip2.js"></script>-->
    <%#= stylesheet_link_tab "base" %>
    <%= javascript_include_tag "http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" %>
    <%= javascript_include_tag "http://maps.google.com/maps/api/js?key=AIzaSyAR_6EezXheWNmpGyHZVA8Y26WHSRrjNT8" %>
    <%= javascript_include_tag 'application' %>
    <script type="text/javascript">
    	function initialize() {

        var mapOptions = {
          
          zoom: 5
        };
        IPMapper.initializeMap("map");
        IPMapper.addIPMarker("123.24.144.163");


        
        
      }

      // google.maps.event.addDomListener(window, 'load', initialize);
      $(document).ready(function(e){
      	// alert(""+document.URL);
      	initialize();
      	var ip = "<%= request.remote_ip %>";
      	var cityd;
      	var cityi = IPMapper.getCity("123.24.144.163",function(result) {
		    // code that depends on 'result'
		   				var urlq = window.location.pathname;
				      	$.ajax({
				      		url:'/welcome/list',
				      		method:'GET',
				      		data:({url:urlq,city:result}),
				      		datatype:'json',
				      		success:function(data){
				      			// dparse = JSON.parse(data);
				      			var i,j;
				      			for(i in data){
				      				// alert(i+" "+data[i]);
				      				IPMapper.addIPMarker("123.24.144.163",data[i][1]);
				      				// for(j in data[i]){
				      				// 	// alert(data[i][j]);
				      					
				      				// 	alert(i+" "+j+" "+data[i][j]);
				      					
				      				// }
				      				// alert(i+" "+data[i]);
				      				
				      				// IPMapper.addIPMarker(data[i]['ip']);
				      			}
				      			// alert(data);


				      		},
				      		error:function(request,status,error){
				      			alert(error);
				      		}
				      	});

		});
      	
      	// alert("6:"+cityi);
      	// $('.box').bind('mouseover',function(e){
      	// 	// alert("hi");
      	// 	$('.box').css("background-color","#ff0");
      	// });
      	
      	// alert(ip_arr[0]);
      	// wireUpEvents();
      	window.onbeforeunload = function(){
      		// var ip = "<%= request.ip %>";
      		// var url = "<%= request.url %>";

      		// return "are u sue??"+ip+" "+url+"";
      		// console.log("hello");
      		// alert("hii");
      		var urlq = window.location.pathname;
      		$.ajax({
      			url : '/welcome/tabclose',
      			method : 'GET',
      			data : ({url:urlq}),
      			datatype: 'JSON',
      			success:function(data){
      				// var ip = "<%= request.ip %>";
		      		// var url = "<%= request.url %>";

		      		// return "are u sue??"+ip+" "+url+"";
      			},
      			error:function(error){
      				alert(error);
      			}

      		});
      	}


      	// $('.box').hover(function(){
      	// 	initialize();
      	// 	$('.mapd').css("display","block");
      	// },function(){
      	// 	$('.mapd').css("display","none");
      	// });
      	




      });
    </script>
 
    
</head>
<body>
    
    <!-- <div id="map" style="height: 500px;"></div> -->
   <!-- <h1>IP: </h1>
   <h1>URL: </h1>
   <h1>CITY:</h1>
   <h1>Listing ip</h1>
	<ul id="ip_list">
	<%# @list.each do |c| %>
	<li><%#= c.ip %>
	</li>
	<%# end %>
	</ul> -->


	<div class="content">
		<div class="box">
			<center>Map</center>
		</div>
		<div class="mapd">
			<div id="map" style="height: 500px;"></div>
		</div>
	</div>






</body>
</html>